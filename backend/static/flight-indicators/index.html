<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/flightindicators.css" />
    <title>Flight Indicators</title>
</head>

<body>
    <div>
        <span id="attitude"></span>
        <span id="heading"></span>
    </div>
    <div>
        <span id="altimeter"></span>
        <span id="variometer"></span>
    </div>
    <script src="js/jquery-3.6.0.min"></script>
    <script src="js/jquery.flightindicators.min.js"></script>
    <script type="text/javascript">
        function calculate_pressure_altitude(pressure, p0 = 101325) {
            return 0.3048 * 145366.45 * (1 - Math.pow(pressure / p0, 0.190284))
        }

        function iir_filter(old_data, new_data, coefficient) {
            return (old_data * coefficient + new_data) / (coefficient + 1);
        }

        var old_p_utc = undefined;
        var old_altitude = undefined;
        var vario = 0;
        var filter_coefficient = 16;
        var size = Math.min(window.innerHeight, window.innerWidth) / 2.05;
        var attitude = $.flightIndicator('#attitude', 'attitude', {
            size: size,
            showBox: false
        });
        var heading = $.flightIndicator('#heading', 'heading', {
            size: size,
            showBox: false
        });
        var variometer = $.flightIndicator('#variometer', 'variometer', {
            vario: 0,
            size: size,
            showBox: false
        });
        var altimeter = $.flightIndicator('#altimeter', 'altimeter', {
            size: size,
            showBox: false
        });
        altimeter.setPressure(1013);

        var ws_imu = new WebSocket("ws://" + window.location.host + "/ws/imu");
        ws_imu.onmessage = function(event) {
            let message = JSON.parse(event.data);
            attitude.setRoll(message.roll);
            attitude.setPitch(message.pitch);
            heading.setHeading(message.yaw);
        }

        var ws_baro = new WebSocket("ws://" + window.location.host + "/ws/barometer");
        ws_baro.onmessage = function(event) {
            let message = JSON.parse(event.data);
            let altitude = calculate_pressure_altitude(message.pressure);
            altimeter.setAltitude(altitude);
            if (old_p_utc != undefined) {
                let new_vario = (altitude - old_altitude) / (message.p_utc - old_p_utc);
                vario = iir_filter(vario, new_vario, filter_coefficient);
                variometer.setVario(vario);
            }
            old_p_utc = message.p_utc;
            old_altitude = altitude;
        }

        window.onresize = function() {
            let size = Math.min(window.innerHeight, window.innerWidth) / 2.05;
            attitude.resize(size);
            heading.resize(size);
            variometer.resize(size);
            altimeter.resize(size);
        };
    </script>
</body>

</html>
